name: üåç Deploy Multi-Cloud

on:
  push:
    branches: [master, main]
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  deploy-cloudflare:
    name: ‚òÅÔ∏è Cloudflare Pages
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Deploy changed domains
        run: |
          # Will be triggered by main deploy-cloudflare-all.yml workflow
          echo "‚úÖ Cloudflare deployment handled by deploy-cloudflare-all.yml"

  deploy-vercel:
    name: ‚ñ≤ Vercel
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    strategy:
      matrix:
        domain:
          - math-blackroad-io
          - blackroadai
          - lucidia-earth
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Deploy to Vercel
        working-directory: domains/${{ matrix.domain }}
        run: |
          if [ -f "package.json" ]; then
            npm ci
            npm run build || true
          fi
          vercel --prod --yes --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: blackroad-${{ matrix.domain }}

  deploy-railway:
    name: üöÇ Railway
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy to Railway
        run: |
          railway up --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

  deploy-digitalocean:
    name: üåä DigitalOcean
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DIGITALOCEAN_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 159.65.43.12 >> ~/.ssh/known_hosts

      - name: Deploy to Droplet
        run: |
          rsync -avz --exclude='.git' --exclude='node_modules' \
            ./ root@159.65.43.12:/opt/blackroad/

          ssh root@159.65.43.12 'cd /opt/blackroad && ./deploy.sh restart'

  deploy-pis:
    name: ü•ß Raspberry Pi Fleet
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Trigger Pi deployment workflow
        run: |
          # This will trigger the deploy-to-pis.yml workflow
          echo "‚úÖ Pi deployment handled by deploy-to-pis.yml"

  update-notion:
    name: üìù Update Notion
    runs-on: ubuntu-latest
    needs: [deploy-cloudflare, deploy-vercel, deploy-railway, deploy-digitalocean]
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Log deployment to Notion
        run: |
          DEPLOY_DATE=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")
          DEPLOY_TITLE="Deployment - $(date '+%Y-%m-%d %H:%M:%S')"

          # Create deployment log page in Notion database
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://api.notion.com/v1/pages" \
            -H "Authorization: Bearer ${NOTION_TOKEN}" \
            -H "Content-Type: application/json" \
            -H "Notion-Version: 2022-06-28" \
            -d "{
              \"parent\": { \"database_id\": \"${NOTION_DATABASE_ID}\" },
              \"properties\": {
                \"Name\": {
                  \"title\": [{ \"text\": { \"content\": \"${DEPLOY_TITLE}\" } }]
                },
                \"Status\": {
                  \"select\": { \"name\": \"Completed\" }
                },
                \"Date\": {
                  \"date\": { \"start\": \"${DEPLOY_DATE}\" }
                },
                \"Platforms\": {
                  \"multi_select\": [
                    { \"name\": \"Cloudflare\" },
                    { \"name\": \"Vercel\" },
                    { \"name\": \"Railway\" },
                    { \"name\": \"DigitalOcean\" },
                    { \"name\": \"Raspberry Pi\" }
                  ]
                }
              },
              \"children\": [
                {
                  \"object\": \"block\",
                  \"type\": \"heading_2\",
                  \"heading_2\": {
                    \"rich_text\": [{ \"text\": { \"content\": \"Deployment Summary\" } }]
                  }
                },
                {
                  \"object\": \"block\",
                  \"type\": \"bulleted_list_item\",
                  \"bulleted_list_item\": {
                    \"rich_text\": [{ \"text\": { \"content\": \"Commit: ${GITHUB_SHA}\" } }]
                  }
                },
                {
                  \"object\": \"block\",
                  \"type\": \"bulleted_list_item\",
                  \"bulleted_list_item\": {
                    \"rich_text\": [{ \"text\": { \"content\": \"Branch: ${GITHUB_REF_NAME}\" } }]
                  }
                },
                {
                  \"object\": \"block\",
                  \"type\": \"bulleted_list_item\",
                  \"bulleted_list_item\": {
                    \"rich_text\": [{ \"text\": { \"content\": \"Triggered by: ${GITHUB_ACTOR}\" } }]
                  }
                }
              ]
            }")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "‚úÖ Deployment logged to Notion successfully"
            PAGE_URL=$(echo "$BODY" | jq -r '.url // "N/A"')
            echo "üìù Notion page: $PAGE_URL"
          else
            echo "‚ö†Ô∏è Failed to log to Notion (HTTP $HTTP_CODE)"
            echo "Response: $BODY"
            # Don't fail the workflow if Notion logging fails
          fi
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}

  update-asana:
    name: üìä Update Asana
    runs-on: ubuntu-latest
    needs: [deploy-cloudflare, deploy-vercel, deploy-railway, deploy-digitalocean]
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Update Asana tasks
        run: |
          DEPLOY_DATE=$(date '+%Y-%m-%d %H:%M:%S')

          # Add a comment to the deployment task with deployment details
          COMMENT_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://app.asana.com/api/1.0/tasks/${ASANA_DEPLOYMENT_TASK_ID}/stories" \
            -H "Authorization: Bearer ${ASANA_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{
              \"data\": {
                \"text\": \"üöÄ Deployment completed at ${DEPLOY_DATE}\n\nPlatforms deployed:\n‚Ä¢ Cloudflare Pages\n‚Ä¢ Vercel\n‚Ä¢ Railway\n‚Ä¢ DigitalOcean\n‚Ä¢ Raspberry Pi Fleet\n\nCommit: ${GITHUB_SHA}\nBranch: ${GITHUB_REF_NAME}\nTriggered by: ${GITHUB_ACTOR}\"
              }
            }")

          COMMENT_HTTP=$(echo "$COMMENT_RESPONSE" | tail -n1)

          if [ "$COMMENT_HTTP" -eq 201 ]; then
            echo "‚úÖ Added deployment comment to Asana task"
          else
            echo "‚ö†Ô∏è Failed to add comment (HTTP $COMMENT_HTTP)"
          fi

          # Mark the deployment task as complete
          COMPLETE_RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT "https://app.asana.com/api/1.0/tasks/${ASANA_DEPLOYMENT_TASK_ID}" \
            -H "Authorization: Bearer ${ASANA_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{
              \"data\": {
                \"completed\": true
              }
            }")

          COMPLETE_HTTP=$(echo "$COMPLETE_RESPONSE" | tail -n1)

          if [ "$COMPLETE_HTTP" -eq 200 ]; then
            echo "‚úÖ Marked Asana deployment task as complete"
          else
            echo "‚ö†Ô∏è Failed to complete task (HTTP $COMPLETE_HTTP)"
            # Don't fail the workflow if Asana update fails
          fi
        env:
          ASANA_TOKEN: ${{ secrets.ASANA_TOKEN }}
          ASANA_DEPLOYMENT_TASK_ID: ${{ secrets.ASANA_DEPLOYMENT_TASK_ID }}

  notify-success:
    name: ‚úÖ Multi-Cloud Deploy Complete
    runs-on: ubuntu-latest
    needs: [deploy-vercel, deploy-railway, deploy-digitalocean, update-notion, update-asana]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "üéâ Multi-Cloud Deployment Complete!"
          echo ""
          echo "Deployed to:"
          echo "  ‚òÅÔ∏è  Cloudflare Pages"
          echo "  ‚ñ≤  Vercel"
          echo "  üöÇ Railway"
          echo "  üåä DigitalOcean"
          echo "  ü•ß Raspberry Pi Fleet"
          echo ""
          echo "Updated:"
          echo "  üìù Notion documentation"
          echo "  üìä Asana project tasks"
